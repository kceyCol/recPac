<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcri√ß√µes - AudioToText</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/transcriptions.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/utilities.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modals.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="nav-links" style="position: absolute; top: 30px; left: 40px; z-index: 2;">
                <a href="/" class="nav-link" style="background: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.2); padding: 12px 24px; border-radius: 50px; text-decoration: none; font-weight: 500; backdrop-filter: blur(10px); display: inline-flex; align-items: center; gap: 8px;">
                    <i class="fas fa-microphone"></i>
                    Grava√ß√µes
                </a>
            </div>
            <h1>üìÑ Transcri√ß√µes</h1>
            <p>Gerencie suas transcri√ß√µes e crie resumos inteligentes</p>
            <div class="user-info">
                <span>üë§ {{ user_name }}</span>
                <a href="/logout" class="logout-btn">üö™ Sair</a>
            </div>
        </div>
        
        <div class="main-content">
            <div id="status" class="status hidden"></div>
            
            <div class="recordings-section">
                <div class="section-header">
                    <h2>üìã Suas Transcri√ß√µes</h2>
                    <div class="sort-controls">
                        <label for="sortBy">üîÑ Ordenar por:</label>
                        <select id="sortBy" onchange="sortTranscriptions()">
                            <option value="date">üìÖ Data (mais recente)</option>
                            <option value="date-asc">üìÖ Data (mais antiga)</option>
                            <option value="patient">üë§ Paciente (A-Z)</option>
                            <option value="patient-desc">üë§ Paciente (Z-A)</option>
                            <option value="size">üìä Tamanho (maior)</option>
                            <option value="size-asc">üìä Tamanho (menor)</option>
                        </select>
                    </div>
                </div>
                <div id="transcriptionsList" class="transcriptions-list">
                    <div class="loading" style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">
                        <i class="fas fa-spinner fa-spin"></i>
                        Carregando transcri√ß√µes...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modais -->
    <div id="viewModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
            <h3 id="viewModalTitle">üìÑ Transcri√ß√£o</h3>
            <div id="viewModalContent" class="transcription-text" style="white-space: pre-wrap;"></div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeViewModal()">‚ùå Fechar</button>
            </div>
        </div>
    </div>
    
    <div id="summaryModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
            <h3>üìã Resumo da Consulta</h3>
            <div id="summaryModalContent" class="transcription-text" style="white-space: pre-wrap;"></div>
            <div class="modal-buttons">
                <button class="modal-btn save" onclick="exportSummaryPDF()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); margin-right: 10px;">
                    <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
                <button class="modal-btn save" onclick="exportSummaryDOCX()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); margin-right: 10px;">
                    <i class="fas fa-file-word"></i> Exportar DOCX
                </button>
                <button class="modal-btn save" onclick="downloadCompleteConversation()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-right: 10px;">
                    <i class="fas fa-download"></i> Baixar Conversa Completa
                </button>
                <button class="modal-btn cancel" onclick="closeSummaryModal()">‚ùå Fechar</button>
            </div>
        </div>
    </div>
    
    <div id="promptModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3>ü§ñ Prompt Personalizado para IA</h3>
            <p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">Descreva como voc√™ gostaria que a IA analise e resuma esta transcri√ß√£o:</p>
            
            <textarea id="customPromptInput" placeholder="Exemplo: Foque nos sintomas principais e medica√ß√µes prescritas. Organize em formato de lista com prioridades..." 
                maxlength="1000"></textarea>
            
            <div class="prompt-tip">
                üí° Dica: Seja espec√≠fico sobre o formato desejado, pontos importantes a destacar, ou estilo de resumo.
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn save" onclick="generateSummaryWithPrompt()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-magic"></i> Gerar Resumo
                </button>
                <button class="modal-btn cancel" onclick="closePromptModal()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>
    
    <script>
        let transcriptions = [];
        let currentFilename = '';
        let currentSortBy = 'date'; // Ordena√ß√£o padr√£o
        
        // Elementos DOM
        const transcriptionsList = document.getElementById('transcriptionsList');
        const status = document.getElementById('status');
        const viewModal = document.getElementById('viewModal');
        const summaryModal = document.getElementById('summaryModal');
        
        // Carregar transcri√ß√µes ao inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadTranscriptions();
        });
        
        // Fun√ß√£o para ordenar transcri√ß√µes
        function sortTranscriptions() {
            const sortBy = document.getElementById('sortBy').value;
            currentSortBy = sortBy;
            
            const sortedTranscriptions = [...transcriptions].sort((a, b) => {
                switch (sortBy) {
                    case 'date':
                        // Data mais recente primeiro - usar timestamp num√©rico
                        return (b.modified_timestamp || 0) - (a.modified_timestamp || 0);
                    
                    case 'date-asc':
                        // Data mais antiga primeiro - usar timestamp num√©rico
                        return (a.modified_timestamp || 0) - (b.modified_timestamp || 0);
                    
                    case 'patient':
                        // Paciente A-Z
                        const nameA = (a.patient_name || 'Sem nome').toLowerCase();
                        const nameB = (b.patient_name || 'Sem nome').toLowerCase();
                        return nameA.localeCompare(nameB, 'pt-BR');
                    
                    case 'patient-desc':
                        // Paciente Z-A
                        const nameA2 = (a.patient_name || 'Sem nome').toLowerCase();
                        const nameB2 = (b.patient_name || 'Sem nome').toLowerCase();
                        return nameB2.localeCompare(nameA2, 'pt-BR');
                    
                    case 'size':
                        // Tamanho maior primeiro
                        return (b.file_size || 0) - (a.file_size || 0);
                    
                    case 'size-asc':
                        // Tamanho menor primeiro
                        return (a.file_size || 0) - (b.file_size || 0);
                    
                    default:
                        return 0;
                }
            });
            
            transcriptions = sortedTranscriptions;
            renderTranscriptions();
        }
        
        // Carregar lista de transcri√ß√µes
        async function loadTranscriptions() {
            try {
                const response = await fetch('/api/transcriptions', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 302 || response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    transcriptions = data.transcriptions || [];
                    // Aplicar ordena√ß√£o padr√£o
                    document.getElementById('sortBy').value = currentSortBy;
                    sortTranscriptions();
                } else {
                    showStatus('‚ùå ' + (data.message || 'Erro desconhecido'), 'error');
                }
            } catch (error) {
                showStatus('‚ùå Erro ao carregar transcri√ß√µes: ' + error.message, 'error');
                transcriptionsList.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao carregar transcri√ß√µes</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <button onclick="loadTranscriptions()" style="margin-top: 10px; padding: 8px 16px; background: #4facfe; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }
        
        // Fun√ß√£o para formatar tamanho do arquivo
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return 'N/A';
            
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Renderizar lista de transcri√ß√µes
        function renderTranscriptions() {
            if (transcriptions.length === 0) {
                transcriptionsList.innerHTML = `
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">
                        <h3>üì≠ Nenhuma transcri√ß√£o encontrada</h3>
                        <p>Voc√™ ainda n√£o possui transcri√ß√µes.</p>
                        <p>V√° para a <a href="/" style="color: #4facfe;">p√°gina de grava√ß√µes</a> para criar suas primeiras transcri√ß√µes.</p>
                    </div>
                `;
                return;
            }
            
            try {
                const html = transcriptions.map((t) => {
                    return `
                        <div class="transcription-card">
                            <div class="card-header">
                                <div class="header-left">
                                    <h3 class="patient-name">${escapeHtml(t.patient_name || 'Sem nome')}</h3>
                                    <div class="card-meta">
                                        <div class="date-info">üìÖ ${escapeHtml(t.modified_date || 'Data n√£o dispon√≠vel')}</div>
                                        <div class="size-info">üìä ${formatFileSize(t.file_size)}</div>
                                        ${t.has_summary ? '<div class="summary-indicator">‚úÖ Resumo dispon√≠vel</div>' : ''}
                                    </div>
                                </div>
                                
                                <div class="header-actions">
                                    <button class="action-btn btn-view" onclick="viewTranscription('${escapeHtml(t.filename)}')" title="Ver Transcri√ß√£o">
                                        <i class="fas fa-eye"></i>
                                        Ver
                                    </button>
                                    
                                    ${t.has_summary ? 
                                        `<button class="action-btn btn-view-summary" onclick="viewSummary('${escapeHtml(t.summary_filename)}')" title="Ver Resumo">
                                            <i class="fas fa-file-alt"></i>
                                            Resumo
                                        </button>` :
                                        `<button class="action-btn btn-summary" onclick="generateSummary('${escapeHtml(t.filename)}')" title="Gerar Resumo">
                                            <i class="fas fa-magic"></i>
                                            Gerar
                                        </button>`
                                    }
                                    
                                    <button class="action-btn btn-download" onclick="downloadTranscription('${escapeHtml(t.filename)}')" title="Download">
                                        <i class="fas fa-download"></i>
                                        Download
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card-content">
                                <div class="preview-container">
                                    <label class="preview-label">üìÑ Pr√©via da Transcri√ß√£o:</label>
                                    <textarea class="preview-text" readonly rows="4">${escapeHtml((t.preview || 'Pr√©via n√£o dispon√≠vel'))}</textarea>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                transcriptionsList.innerHTML = html;
                
            } catch (error) {
                transcriptionsList.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao renderizar transcri√ß√µes</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Fun√ß√£o para escapar HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Visualizar transcri√ß√£o
        async function viewTranscription(filename) {
            try {
                const response = await fetch(`/view_transcription/${encodeURIComponent(filename)}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('viewModalTitle').textContent = 'üìÑ Transcri√ß√£o - ' + filename.replace('_transcricao.txt', '');
                    document.getElementById('viewModalContent').textContent = data.content;
                    viewModal.style.display = 'block';
                } else {
                    showStatus('‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Erro ao carregar transcri√ß√£o: ' + error.message, 'error');
            }
        }
        
        // Gerar resumo
        async function generateSummary(filename) {
            currentFilename = filename;
            document.getElementById('customPromptInput').value = '';
            document.getElementById('promptModal').style.display = 'block';
        }
        
        // Nova fun√ß√£o para gerar resumo com prompt personalizado
        async function generateSummaryWithPrompt() {
            const customPrompt = document.getElementById('customPromptInput').value.trim();
            
            try {
                closePromptModal();
                showStatus('ü§ñ Gerando resumo personalizado com IA...', 'info');
                
                const response = await fetch('/api/generate_summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        filename: currentFilename,
                        custom_prompt: customPrompt
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus('‚úÖ ' + data.message, 'success');
                    document.getElementById('summaryModalContent').textContent = data.summary;
                    summaryModal.style.display = 'block';
                    loadTranscriptions(); // Recarregar lista
                } else {
                    showStatus('‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Erro ao gerar resumo: ' + error.message, 'error');
            }
        }
        
        // Fun√ß√£o para fechar modal de prompt
        function closePromptModal() {
            document.getElementById('promptModal').style.display = 'none';
        }
        
        // Visualizar resumo existente
        let currentSummaryFilename = '';
        
        // Atualizar fun√ß√£o viewSummary para armazenar o filename
        async function viewSummary(filename) {
            try {
                currentSummaryFilename = filename;
                const response = await fetch(`/api/view_summary/${encodeURIComponent(filename)}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('summaryModalContent').textContent = data.content;
                    summaryModal.style.display = 'block';
                } else {
                    showStatus('‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Erro ao carregar resumo: ' + error.message, 'error');
            }
        }
        
        // Fun√ß√£o para exportar resumo em PDF
        function exportSummaryPDF() {
            if (!currentSummaryFilename) {
                showStatus('‚ùå Nenhum resumo selecionado', 'error');
                return;
            }
            
            showStatus('üìÑ Gerando PDF...', 'info');
            window.open(`/export_summary_pdf/${encodeURIComponent(currentSummaryFilename)}`, '_blank');
            
            setTimeout(() => {
                showStatus('‚úÖ PDF gerado com sucesso!', 'success');
            }, 1000);
        }
        
        // Fun√ß√£o para exportar resumo em DOCX
        function exportSummaryDOCX() {
            if (!currentSummaryFilename) {
                showStatus('‚ùå Nenhum resumo selecionado', 'error');
                return;
            }
            
            showStatus('üìù Gerando DOCX...', 'info');
            window.open(`/export_summary_docx/${encodeURIComponent(currentSummaryFilename)}`, '_blank');
            
            setTimeout(() => {
                showStatus('‚úÖ DOCX gerado com sucesso!', 'success');
            }, 1000);
        }
        
        // Atualizar fun√ß√£o generateSummaryWithPrompt para armazenar filename
        async function generateSummaryWithPrompt() {
            const customPrompt = document.getElementById('customPromptInput').value.trim();
            
            try {
                closePromptModal();
                showStatus('ü§ñ Gerando resumo personalizado com IA...', 'info');
                
                const response = await fetch('/api/generate_summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        filename: currentFilename,
                        custom_prompt: customPrompt
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus('‚úÖ ' + data.message, 'success');
                    currentSummaryFilename = data.summary_filename; // Armazenar filename do resumo
                    document.getElementById('summaryModalContent').textContent = data.summary;
                    summaryModal.style.display = 'block';
                    loadTranscriptions(); // Recarregar lista
                } else {
                    showStatus('‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Erro ao gerar resumo: ' + error.message, 'error');
            }
        }
        
        // Download de transcri√ß√£o
        function downloadTranscription(filename) {
            window.open(`/download_transcription/${encodeURIComponent(filename)}`, '_blank');
        }
        
        // Fun√ß√£o para baixar conversa completa
        function downloadCompleteConversation() {
            if (!currentSummaryFilename) {
                showStatus('‚ùå Nenhum resumo selecionado', 'error');
                return;
            }
            
            const baseName = currentSummaryFilename.replace('_resumo.txt', '');
            const completeFilename = baseName + '_conversa_completa.txt';
            
            showStatus('üì• Baixando conversa completa...', 'info');
            window.open(`/download_transcription/${encodeURIComponent(completeFilename)}`, '_blank');
            
            setTimeout(() => {
                showStatus('‚úÖ Download iniciado!', 'success');
            }, 1000);
        }
        
        // Fechar modais
        function closeViewModal() {
            viewModal.style.display = 'none';
        }
        
        function closeSummaryModal() {
            summaryModal.style.display = 'none';
        }
        
        // Mostrar status
        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    status.classList.add('hidden');
                }, 3000);
            }
        }
        
        // Fechar modais ao clicar fora
        window.onclick = function(event) {
            const viewModal = document.getElementById('viewModal');
            const summaryModal = document.getElementById('summaryModal');
            const promptModal = document.getElementById('promptModal');
            
            if (event.target === viewModal) {
                closeViewModal();
            }
            if (event.target === summaryModal) {
                closeSummaryModal();
            }
            if (event.target === promptModal) {
                closePromptModal();
            }
        }
    </script>
</body>
</html>